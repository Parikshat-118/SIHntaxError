<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è RoadLink Route Planner - Fastest Routes Only</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #3b82f6;
            --accent: #10b981;
            --dark: #1e293b;
            --light: #f0f8ff;
            --warning: #f59e0b;
            --danger: #ef4444;
            --success: #22c55e;
            --gradient: linear-gradient(135deg, var(--primary), var(--accent));
            --text-gray: #475569;
            --light-blue-bg: #ebf5ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Header */
        header {
            background-color: white;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 8px;
            color: var(--accent);
            font-size: 1.8rem;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            padding: 8px 15px;
            border-radius: 25px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            background-color: var(--light-blue-bg);
            color: var(--primary);
        }

        .back-btn {
            background: var(--gradient);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: transform 0.3s;
        }

        .back-btn:hover {
            transform: translateY(-2px);
        }

        /* Main Layout */
        .main-container {
            margin-top: 70px;
            height: calc(100vh - 70px);
            display: flex;
        }

        .sidebar {
            width: 400px;
            background: white;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 500;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #route-map {
            height: 100%;
            width: 100%;
        }

        /* Sidebar Content */
        .sidebar-header {
            background: var(--gradient);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .sidebar-content {
            padding: 25px;
        }

        .route-form {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .route-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .route-option {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s;
        }

        .route-option:hover {
            border-color: var(--primary);
        }

        .route-option.active {
            border-color: var(--primary);
            background: var(--light-blue-bg);
            color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        /* Route Results */
        .route-results {
            border-top: 2px solid #e2e8f0;
            padding-top: 25px;
            display: none;
        }

        .route-results.show {
            display: block;
        }

        .route-card {
            background: var(--light-blue-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .route-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .route-card.selected {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-type {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .route-priority {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .priority-fastest {
            background: var(--success);
            color: white;
        }

        .priority-shortest {
            background: var(--primary);
            color: white;
        }

        .priority-safest {
            background: var(--warning);
            color: white;
        }

        .route-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }

        .stat-value {
            display: block;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: 5px;
        }

        .route-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .feature-tag {
            padding: 4px 8px;
            background: var(--accent);
            color: white;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Traffic Incidents */
        .traffic-incidents {
            margin-top: 30px;
        }

        .incident-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .incident-critical {
            border-left-color: var(--danger);
        }

        .incident-high {
            border-left-color: var(--warning);
        }

        .incident-medium {
            border-left-color: var(--primary);
        }

        .incident-low {
            border-left-color: var(--success);
        }

        .incident-icon {
            font-size: 1.2rem;
            margin-right: 12px;
        }

        .incident-info {
            flex: 1;
        }

        .incident-type {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .incident-location {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-top: 2px;
        }

        /* Transportation Mode Styles */
        .transport-modes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .transport-mode {
            padding: 12px 8px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .transport-mode i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        .transport-mode:hover {
            border-color: var(--primary);
            background: var(--light-blue-bg);
        }
        
        .transport-mode.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .transport-mode.car {
            color: #2563eb;
        }
        
        .transport-mode.bike {
            color: #059669;
        }
        
        .transport-mode.walk {
            color: #dc2626;
        }
        
        .transport-mode.transit {
            color: #7c3aed;
        }
        
        .transport-mode.active {
            color: white !important;
        }
        
        /* Enhanced Route Stats */
        .enhanced-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-enhanced {
            text-align: center;
            padding: 12px 8px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-enhanced .stat-icon {
            font-size: 1.1rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .stat-enhanced .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
            line-height: 1.2;
        }
        
        .stat-enhanced .stat-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            margin-top: 2px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }

            .sidebar {
                width: 100%;
                height: auto;
                min-height: 60vh;
                order: 1;
            }

            .map-container {
                height: 40vh;
                min-height: 300px;
                order: 2;
            }
            
            .sidebar-content {
                padding: 15px;
            }
            
            .sidebar-header {
                padding: 20px 15px;
            }
            
            .sidebar-header h2 {
                font-size: 1.2rem;
            }

            .nav-links {
                display: none;
            }

            .route-options {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .route-option {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .transport-modes {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
                margin-bottom: 15px;
            }
            
            .transport-mode {
                padding: 8px 4px;
                font-size: 0.7rem;
            }
            
            .transport-mode i {
                font-size: 1rem;
            }

            .route-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .enhanced-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat {
                padding: 8px;
            }
            
            .stat-enhanced {
                padding: 8px 4px;
            }
            
            .stat-value, .stat-enhanced .stat-value {
                font-size: 1rem;
            }
            
            .stat-label, .stat-enhanced .stat-label {
                font-size: 0.7rem;
            }
            
            .form-group input {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .btn {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .route-card {
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .route-type {
                font-size: 1rem;
            }
            
            .route-priority {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            .feature-tag {
                padding: 3px 6px;
                font-size: 0.65rem;
            }
            
            .traffic-incidents {
                margin-top: 20px;
            }
            
            .incident-item {
                padding: 10px;
            }
            
            .incident-type {
                font-size: 0.8rem;
            }
            
            .incident-location {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                min-height: 70vh;
            }
            
            .map-container {
                height: 30vh;
            }
            
            .route-options {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .transport-modes {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .enhanced-stats {
                grid-template-columns: 1fr;
            }
            
            .route-stats {
                grid-template-columns: 1fr;
            }
            
            .sidebar-header h2 {
                font-size: 1.1rem;
            }
        }

        /* Loading Animation */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-btn {
            padding: 10px;
            background: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .map-btn:hover {
            background: var(--light-blue-bg);
            transform: scale(1.05);
        }

        .map-btn.active {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <nav>
            <a href="index.html" class="logo">
                <i class="fas fa-route"></i>
                Smart Route Planner
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#features">Features</a></li>
                <li><a href="index.html#contact">Contact</a></li>
            </ul>
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Platform
            </a>
        </nav>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-map-marked-alt"></i> Route Planning</h2>
                <p>AI-powered traffic-aware navigation</p>
            </div>

            <div class="sidebar-content">
                <!-- Route Form -->
                <form class="route-form" id="routeForm">
                    <div class="form-group">
                        <label for="fromLocation">
                            <i class="fas fa-circle" style="color: var(--success);"></i> From
                        </label>
                        <input type="text" id="fromLocation" placeholder="Enter starting location..." />
                    </div>

                    <div class="form-group">
                        <label for="toLocation">
                            <i class="fas fa-map-marker-alt" style="color: var(--danger);"></i> To
                        </label>
                        <input type="text" id="toLocation" placeholder="Enter destination..." />
                    </div>

                    <!-- Transportation Modes -->
                    <div class="transport-modes">
                        <div class="transport-mode car active" data-transport="car">
                            <i class="fas fa-car"></i>
                            <span>Car</span>
                        </div>
                        <div class="transport-mode bike" data-transport="bike">
                            <i class="fas fa-bicycle"></i>
                            <span>Bike</span>
                        </div>
                        <div class="transport-mode walk" data-transport="walk">
                            <i class="fas fa-walking"></i>
                            <span>Walk</span>
                        </div>
                        <div class="transport-mode transit" data-transport="transit">
                            <i class="fas fa-bus"></i>
                            <span>Transit</span>
                        </div>
                    </div>
                    
                    <!-- Route Options -->
                    <div class="route-options">
                        <div class="route-option active" data-option="fastest">
                            <i class="fas fa-tachometer-alt"></i><br>
                            Fastest
                        </div>
                        <div class="route-option" data-option="shortest">
                            <i class="fas fa-route"></i><br>
                            Shortest
                        </div>
                        <div class="route-option" data-option="safest">
                            <i class="fas fa-shield-alt"></i><br>
                            Safest
                        </div>
                        <div class="route-option" data-option="eco">
                            <i class="fas fa-leaf"></i><br>
                            Eco-Friendly
                        </div>
                    </div>

                    <button type="submit" class="btn" id="calculateBtn">
                        <i class="fas fa-search"></i> Calculate Route
                    </button>
                </form>

                <!-- Route Results -->
                <div class="route-results" id="routeResults">
                    <h3><i class="fas fa-list"></i> Route Options</h3>
                    <div id="routeList"></div>
                </div>

                <!-- Traffic Incidents -->
                <div class="traffic-incidents">
                    <h3><i class="fas fa-exclamation-triangle"></i> Nearby Incidents</h3>
                    <div id="incidentsList"></div>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="route-map"></div>

            <!-- Map Controls -->
            <div class="map-controls">
                <button class="map-btn" id="toggleTraffic" title="Toggle Traffic Layer">
                    <i class="fas fa-car"></i>
                </button>
                <button class="map-btn" id="toggleIncidents" title="Toggle Incidents">
                    <i class="fas fa-exclamation-triangle"></i>
                </button>
                <button class="map-btn" id="centerMap" title="Center Map">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // Global Variables
let map;
let routingControl;
let incidentsLayer;
let trafficLayer;
let currentRoutes = [];
let selectedRoute = null;
let socket;

// Demo Route Data with Multiple Transportation Modes
const demoRoutes = {
    'Connaught Place to Gurgaon': {
        car: [
            {
                type: 'Fastest Route (via NH8)',
                priority: 'fastest',
                distance: '32.5 km',
                time: '45 min',
                fuel: '‚Çπ185',
                co2: '7.2 kg',
                features: ['Toll Road', 'Highway', 'Traffic Updates'],
                coordinates: [[28.6315, 77.2167], [28.5321, 77.1897], [28.4817, 77.1873], [28.4595, 77.0266]],
                incidents: ['Medium traffic on NH8', 'Construction work near Udyog Vihar']
            },
            {
                type: 'Shortest Route (via Ring Road)',
                priority: 'shortest',
                distance: '28.8 km',
                time: '52 min',
                fuel: '‚Çπ165',
                co2: '6.4 kg',
                features: ['City Roads', 'Shorter Distance', 'Local Traffic'],
                coordinates: [[28.6315, 77.2167], [28.6139, 77.2090], [28.5532, 77.2750], [28.4817, 77.1873]],
                incidents: ['Heavy traffic at ITO', 'Slow traffic on Ring Road']
            },
            {
                type: 'Safest Route (via Mehrauli)',
                priority: 'safest',
                distance: '35.2 km',
                time: '48 min',
                fuel: '‚Çπ195',
                co2: '7.8 kg',
                features: ['Well-lit Roads', 'Less Crowded', 'Safe Areas'],
                coordinates: [[28.6315, 77.2167], [28.5245, 77.1855], [28.5167, 77.2167], [28.4595, 77.0266]],
                incidents: ['Clear roads', 'Good lighting']
            },
            {
                type: 'Eco-Friendly Route',
                priority: 'eco',
                distance: '30.1 km',
                time: '50 min',
                fuel: '‚Çπ155',
                co2: '5.8 kg',
                features: ['Less Traffic', 'Fuel Efficient', 'Green Route'],
                coordinates: [[28.6315, 77.2167], [28.5355, 77.3910], [28.5800, 77.3200], [28.4595, 77.0266]],
                incidents: ['Smooth traffic flow', 'Metro construction nearby']
            }
        ],
        bike: [
            {
                type: 'Bike Route (via Ring Road)',
                priority: 'fastest',
                distance: '29.2 km',
                time: '1h 15min',
                fuel: 'No cost',
                co2: '0 kg',
                features: ['Bike Lanes', 'Exercise', 'Eco-Friendly'],
                coordinates: [[28.6315, 77.2167], [28.6139, 77.2090], [28.5532, 77.2750], [28.4817, 77.1873]],
                incidents: ['Dedicated bike lanes available', 'Good road conditions']
            }
        ],
        walk: [
            {
                type: 'Walking Route (via Main Roads)',
                priority: 'safest',
                distance: '30.5 km',
                time: '6h 20min',
                fuel: 'No cost',
                co2: '0 kg',
                features: ['Pedestrian Paths', 'Exercise', 'Zero Emissions'],
                coordinates: [[28.6315, 77.2167], [28.6139, 77.2090], [28.5532, 77.2750], [28.4817, 77.1873]],
                incidents: ['Safe pedestrian crossings', 'Well-maintained sidewalks']
            }
        ],
        transit: [
            {
                type: 'Metro + Bus Route',
                priority: 'fastest',
                distance: '35.8 km',
                time: '1h 35min',
                fuel: '‚Çπ65',
                co2: '1.2 kg',
                features: ['Public Transport', 'Cost Effective', 'Low Emissions'],
                coordinates: [[28.6315, 77.2167], [28.6139, 77.2090], [28.5532, 77.2750], [28.4817, 77.1873]],
                incidents: ['Metro running on schedule', 'Bus frequency normal']
            }
        ]
    },
    'Dwarka to Noida': {
        car: [
            {
                type: 'Fastest Route (via Outer Ring Road)',
                priority: 'fastest',
                distance: '45.2 km',
                time: '55 min',
                fuel: '‚Çπ245',
                co2: '10.1 kg',
                features: ['Express Route', 'Less Signals', 'Highway Stretch'],
                coordinates: [[28.5921, 77.0460], [28.6542, 77.2373], [28.6304, 77.2177], [28.5355, 77.3910]],
                incidents: ['Normal traffic flow', 'Road work near Kashmere Gate']
            },
            {
                type: 'Shortest Route (via Central Delhi)',
                priority: 'shortest',
                distance: '38.7 km',
                time: '1h 8min',
                fuel: '‚Çπ210',
                co2: '8.6 kg',
                features: ['Direct Route', 'City Center', 'Multiple Signals'],
                coordinates: [[28.5921, 77.0460], [28.6315, 77.2167], [28.6667, 77.2167], [28.5355, 77.3910]],
                incidents: ['Heavy traffic in CP area', 'Congestion at Red Fort']
            },
            {
                type: 'Safest Route (via Yamuna Bank)',
                priority: 'safest',
                distance: '42.1 km',
                time: '1h 2min',
                fuel: '‚Çπ230',
                co2: '9.4 kg',
                features: ['River Route', 'Good Roads', 'Police Patrolling'],
                coordinates: [[28.5921, 77.0460], [28.6200, 77.2700], [28.6800, 77.2200], [28.5355, 77.3910]],
                incidents: ['Smooth journey expected', 'Police checkpoints active']
            }
        ],
        bike: [
            {
                type: 'Cross-City Bike Route',
                priority: 'fastest',
                distance: '40.5 km',
                time: '2h 10min',
                fuel: 'No cost',
                co2: '0 kg',
                features: ['Long Distance', 'Exercise', 'Scenic Route'],
                coordinates: [[28.5921, 77.0460], [28.6304, 77.2177], [28.5355, 77.3910]],
                incidents: ['Bike lanes available on major roads', 'Rest stops available']
            }
        ],
        walk: [
            {
                type: 'Not Recommended - Too Far',
                priority: 'safest',
                distance: '41.8 km',
                time: '8h 45min',
                fuel: 'No cost',
                co2: '0 kg',
                features: ['Extreme Distance', 'Not Practical', 'Consider Other Options'],
                coordinates: [[28.5921, 77.0460], [28.6315, 77.2167], [28.5355, 77.3910]],
                incidents: ['Walking not recommended for this distance', 'Consider public transport']
            }
        ],
        transit: [
            {
                type: 'Metro Blue + Pink Line',
                priority: 'fastest',
                distance: '48.2 km',
                time: '1h 45min',
                fuel: '‚Çπ85',
                co2: '1.8 kg',
                features: ['Metro Connection', 'Air Conditioned', 'Reliable'],
                coordinates: [[28.5921, 77.0460], [28.6315, 77.2167], [28.5355, 77.3910]],
                incidents: ['Normal metro operations', 'Change at Rajiv Chowk']
            }
        ]
    },
    'India Gate to Airport': {
        car: [
            {
                type: 'Airport Express Route',
                priority: 'fastest',
                distance: '18.5 km',
                time: '25 min',
                fuel: '‚Çπ105',
                co2: '4.1 kg',
                features: ['Express Highway', 'No Signals', 'Direct Route'],
                coordinates: [[28.6139, 77.2090], [28.5245, 77.1855], [28.5167, 77.2167], [28.5562, 77.0999]],
                incidents: ['Clear roads to airport', 'Normal flight operations']
            },
            {
                type: 'City Route (via ITO)',
                priority: 'shortest',
                distance: '16.2 km',
                time: '32 min',
                fuel: '‚Çπ95',
                co2: '3.6 kg',
                features: ['City Roads', 'Multiple Routes', 'Local Traffic'],
                coordinates: [[28.6139, 77.2090], [28.6500, 77.2100], [28.5245, 77.1855], [28.5562, 77.0999]],
                incidents: ['Moderate traffic at ITO', 'Construction work on Ring Road']
            }
        ],
        bike: [
            {
                type: 'Airport Bike Route',
                priority: 'fastest',
                distance: '17.8 km',
                time: '55 min',
                fuel: 'No cost',
                co2: '0 kg',
                features: ['Good for Light Luggage', 'Exercise', 'Quick'],
                coordinates: [[28.6139, 77.2090], [28.5245, 77.1855], [28.5562, 77.0999]],
                incidents: ['Airport allows bikes', 'Parking available']
            }
        ],
        transit: [
            {
                type: 'Airport Express Metro',
                priority: 'fastest',
                distance: '19.2 km',
                time: '22 min',
                fuel: '‚Çπ60',
                co2: '0.6 kg',
                features: ['High Speed', 'Luggage Space', 'Direct Connection'],
                coordinates: [[28.6139, 77.2090], [28.5562, 77.0999]],
                incidents: ['Express service running', 'Every 10 minutes']
            }
        ]
    }
};

// Demo Traffic Incidents along routes
const routeIncidents = [
    {
        id: 1,
        type: 'construction',
        severity: 'medium',
        location: 'NH8 - Udyog Vihar',
        description: 'Road widening work in progress',
        impact: 'Expect 10-15 min delay',
        icon: 'fas fa-tools',
        lat: 28.4817,
        lng: 77.1873
    },
    {
        id: 2,
        type: 'accident',
        severity: 'high',
        location: 'Ring Road - ITO Junction',
        description: 'Minor collision, lane blocked',
        impact: 'Heavy traffic backup',
        icon: 'fas fa-car-crash',
        lat: 28.6500,
        lng: 77.2100
    },
    {
        id: 3,
        type: 'traffic_jam',
        severity: 'medium',
        location: 'Outer Ring Road - Kashmere Gate',
        description: 'Rush hour congestion',
        impact: 'Slow moving traffic',
        icon: 'fas fa-car',
        lat: 28.6562,
        lng: 77.2410
    },
    {
        id: 4,
        type: 'vip_movement',
        severity: 'high',
        location: 'Rajpath - India Gate',
        description: 'VIP convoy movement',
        impact: 'Road closure for 30 minutes',
        icon: 'fas fa-shield-alt',
        lat: 28.6129,
        lng: 77.2295
    },
    {
        id: 5,
        type: 'weather',
        severity: 'low',
        location: 'Airport Road - T3 Terminal',
        description: 'Light fog, reduced visibility',
        impact: 'Drive carefully',
        icon: 'fas fa-cloud',
        lat: 28.5562,
        lng: 77.0999
    }
];

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    // Initialize components that DON'T depend on the map first
    initializeForm();
    
    // Initialize map after a short delay to ensure the DOM layout is ready
    setTimeout(() => {
        initializeMap();
    }, 100);
    
    // Initialize WebSocket connection
    try {
        socket = io();
    } catch (error) {
        console.log('WebSocket not available:', error);
    }
});

// Handle window resize for map
window.addEventListener('resize', function() {
    if (map) {
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }
});

// Handle orientation change on mobile
window.addEventListener('orientationchange', function() {
    if (map) {
        setTimeout(() => {
            map.invalidateSize();
        }, 500);
    }
});

// Initialize Map
function initializeMap() {
    try {
        // Check if Leaflet is loaded
        if (typeof L === 'undefined') {
            console.error('Leaflet library not loaded');
            showMapError();
            return;
        }
        
        // Ensure map container exists
        const mapContainer = document.getElementById('route-map');
        if (!mapContainer) {
            console.error('Map container not found');
            return;
        }
        
        // Initialize map with error handling
        map = L.map('route-map', {
            center: [28.6139, 77.2090],
            zoom: 11,
            zoomControl: true,
            attributionControl: true
        });

        // Add base tile layer with error handling
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18,
            errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk1hcCBMb2FkaW5nLi4uPC90ZXh0Pjwvc3ZnPg=='
        }).addTo(map);

        // Initialize incidents layer
        incidentsLayer = L.layerGroup().addTo(map);
        
        // CORRECTED ORDER: Call functions that depend on the map AFTER it's created
        addIncidentsToMap();
        initializeMapControls();
        loadNearbyIncidents();
        
        // Force map to resize after a short delay
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
            }
        }, 250);
        
        console.log('Map initialized successfully');
        
        // Show success message with a fade-in effect
        mapContainer.style.opacity = '0';
        mapContainer.style.transition = 'opacity 0.5s ease-in-out';
        setTimeout(() => {
            mapContainer.style.opacity = '1';
        }, 100);
        
    } catch (error) {
        console.error('Error initializing map:', error);
        showMapError();
    }
}

function showMapError() {
    const mapContainer = document.getElementById('route-map');
    if (mapContainer) {
        mapContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8fafc; color: #64748b; text-align: center; padding: 20px;">
                <div>
                    <i class="fas fa-map-marked-alt" style="font-size: 3rem; margin-bottom: 1rem; color: #cbd5e1;"></i>
                    <h3 style="margin-bottom: 0.5rem; color: #475569;">Map Loading Issue</h3>
                    <p style="margin-bottom: 1rem;">Unable to load the interactive map. Please refresh the page or try again.</p>
                    <button onclick="location.reload()" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-redo"></i> Refresh Page
                    </button>
                </div>
            </div>
        `;
    }
}

// Add incidents to map layer
function addIncidentsToMap() {
    routeIncidents.forEach(incident => {
        const color = getSeverityColor(incident.severity);
        const marker = L.circleMarker([incident.lat, incident.lng], {
            color: color,
            fillColor: color,
            fillOpacity: 0.7,
            radius: getSeverityRadius(incident.severity)
        });

        const popupContent = `
            <div class="incident-popup">
                <h4><i class="${incident.icon}"></i> ${incident.type.replace('_', ' ').toUpperCase()}</h4>
                <p><strong>Location:</strong> ${incident.location}</p>
                <p><strong>Description:</strong> ${incident.description}</p>
                <p><strong>Impact:</strong> ${incident.impact}</p>
                <span class="severity-badge ${incident.severity}">${incident.severity.toUpperCase()}</span>
            </div>
        `;

        marker.bindPopup(popupContent);
        incidentsLayer.addLayer(marker);
    });
}

// Initialize Form
function initializeForm() {
    const routeForm = document.getElementById('routeForm');
    const routeOptions = document.querySelectorAll('.route-option');
    const transportModes = document.querySelectorAll('.transport-mode');
    
    // Handle transportation mode selection
    transportModes.forEach(mode => {
        mode.addEventListener('click', () => {
            transportModes.forEach(m => m.classList.remove('active'));
            mode.classList.add('active');
        });
    });
    
    // Handle route option selection
    routeOptions.forEach(option => {
        option.addEventListener('click', () => {
            routeOptions.forEach(opt => opt.classList.remove('active'));
            option.classList.add('active');
        });
    });

    // Handle form submission
    routeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        calculateRoute();
    });

    // Add sample data for demo
    addSampleLocations();
}

// Add sample locations for demo
function addSampleLocations() {
    const fromInput = document.getElementById('fromLocation');
    const toInput = document.getElementById('toLocation');
    
    // Check if route data was transferred from main website
    const transferredData = localStorage.getItem('routePlannerData');
    if (transferredData) {
        try {
            const routeData = JSON.parse(transferredData);
            // Check if data is recent (within last 5 minutes)
            if (Date.now() - routeData.timestamp < 300000) {
                fromInput.value = routeData.from;
                toInput.value = routeData.to;
                
                // Clear the stored data
                localStorage.removeItem('routePlannerData');
                
                // Auto-calculate route if both locations are provided
                setTimeout(() => {
                    calculateRoute();
                }, 1000);
                
                return;
            }
        } catch (error) {
            console.error('Error reading transferred route data:', error);
        }
        // Clear old/invalid data
        localStorage.removeItem('routePlannerData');
    }
    
    // Predefined popular locations
    const locations = [
        'Connaught Place, New Delhi',
        'India Gate, New Delhi',
        'Red Fort, Delhi',
        'Gurgaon Cyber City',
        'Noida Sector 18',
        'Dwarka Sector 21',
        'Delhi Airport Terminal 3',
        'Karol Bagh Market',
        'Lajpat Nagar Market',
        'Saket Select City Walk',
        'Khan Market, Delhi',
        'Chandni Chowk, Delhi'
    ];

    // Add autocomplete functionality (simplified)
    [fromInput, toInput].forEach(input => {
        input.addEventListener('focus', () => {
            // In a real app, this would show a dropdown with suggestions
            if (!input.value) {
                input.placeholder = locations[Math.floor(Math.random() * locations.length)];
            }
        });
    });
}

// Calculate Route
function calculateRoute() {
    const fromLocation = document.getElementById('fromLocation').value;
    const toLocation = document.getElementById('toLocation').value;
    const selectedOption = document.querySelector('.route-option.active').dataset.option;

    if (!fromLocation || !toLocation) {
        alert('Please enter both from and to locations');
        return;
    }

    // Show loading
    const calculateBtn = document.getElementById('calculateBtn');
    calculateBtn.innerHTML = '<div class="spinner"></div> Calculating...';
    calculateBtn.disabled = true;

    // Simulate API call
    setTimeout(() => {
        processRouteCalculation(fromLocation, toLocation, selectedOption);
        calculateBtn.innerHTML = '<i class="fas fa-search"></i> Calculate Route';
        calculateBtn.disabled = false;
    }, 2000);
}

// Process Route Calculation
function processRouteCalculation(from, to, option) {
    const routeKey = `${from} to ${to}`;
    const selectedTransport = document.querySelector('.transport-mode.active').dataset.transport;
    
    // Use demo data or generate realistic routes based on transport mode
    let routes;
    if (demoRoutes[routeKey] && demoRoutes[routeKey][selectedTransport]) {
        routes = demoRoutes[routeKey][selectedTransport];
    } else {
        routes = generateRoutes(from, to, selectedTransport);
    }
    
    // Sort routes based on selected option
    if (option === 'fastest') {
        routes.sort((a, b) => parseTime(a.time) - parseTime(b.time));
    } else if (option === 'shortest') {
        routes.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
    }

    displayRoutes(routes);
    highlightRecommendedRoute(routes[0]);
}

// Helper function to parse time strings for sorting
function parseTime(timeStr) {
    const match = timeStr.match(/(\d+)h\s*(\d+)?min|^(\d+)\s*min$/);
    if (match) {
        const hours = parseInt(match[1] || 0);
        const minutes = parseInt(match[2] || match[3] || 0);
        return hours * 60 + minutes;
    }
    return 0;
}

// Generate Routes (fallback)
function generateRoutes(from, to, transport = 'car') {
    const baseRoutes = {
        car: [
            {
                type: 'Recommended Route',
                priority: 'fastest',
                distance: '24.5 km',
                time: '38 min',
                fuel: '‚Çπ145',
                co2: '5.5 kg',
                features: ['Live Traffic', 'Shortest Time', 'Toll Route'],
                coordinates: [[28.6315, 77.2167], [28.6139, 77.2090], [28.5532, 77.2750], [28.5355, 77.3910]],
                incidents: ['Normal traffic flow', 'No major incidents']
            },
            {
                type: 'Alternative Route',
                priority: 'shortest',
                distance: '22.1 km',
                time: '42 min',
                fuel: '‚Çπ135',
                co2: '4.9 kg',
                features: ['Shorter Distance', 'City Roads', 'No Tolls'],
                coordinates: [[28.6315, 77.2167], [28.6500, 77.2100], [28.6200, 77.2700], [28.5355, 77.3910]],
                incidents: ['Light traffic expected', 'Road work on Ring Road']
            }
        ],
        bike: [
            {
                type: 'Bike Route',
                priority: 'fastest',
                distance: '23.8 km',
                time: '1h 12min',
                fuel: 'No cost',
                co2: '0 kg',
                features: ['Bike Lanes', 'Exercise', 'Eco-Friendly'],
                coordinates: [[28.6315, 77.2167], [28.6139, 77.2090], [28.5532, 77.2750], [28.5355, 77.3910]],
                incidents: ['Bike-friendly routes', 'Good road conditions']
            }
        ],
        walk: [
            {
                type: 'Walking Route',
                priority: 'safest',
                distance: '24.8 km',
                time: '5h 15min',
                fuel: 'No cost',
                co2: '0 kg',
                features: ['Pedestrian Paths', 'Exercise', 'Zero Emissions'],
                coordinates: [[28.6315, 77.2167], [28.6139, 77.2090], [28.5532, 77.2750], [28.5355, 77.3910]],
                incidents: ['Safe sidewalks', 'Well-lit paths']
            }
        ],
        transit: [
            {
                type: 'Public Transport Route',
                priority: 'fastest',
                distance: '26.4 km',
                time: '1h 25min',
                fuel: '‚Çπ55',
                co2: '0.8 kg',
                features: ['Metro + Bus', 'Cost Effective', 'Low Emissions'],
                coordinates: [[28.6315, 77.2167], [28.6139, 77.2090], [28.5532, 77.2750], [28.5355, 77.3910]],
                incidents: ['Regular service', 'On-time schedule']
            }
        ]
    };
    
    return baseRoutes[transport] || baseRoutes.car;
}

// Display Routes
function displayRoutes(routes) {
    const routeResults = document.getElementById('routeResults');
    const routeList = document.getElementById('routeList');
    
    routeList.innerHTML = '';
    
    routes.forEach((route, index) => {
        const routeCard = document.createElement('div');
        routeCard.className = 'route-card';
        routeCard.dataset.routeIndex = index;
        
        const currentTransport = document.querySelector('.transport-mode.active').dataset.transport;
        const transportIcons = {
            car: 'üöó',
            bike: 'üö¥',
            walk: 'üö∂',
            transit: 'üöå'
        };
        
        routeCard.innerHTML = `
            <div class="route-header">
                <div class="route-type">${transportIcons[currentTransport]} ${route.type}</div>
                <div class="route-priority priority-${route.priority}">${route.priority}</div>
            </div>
            <div class="route-stats">
                <div class="enhanced-stats">
                    <div class="stat-enhanced">
                        <span class="stat-icon">üìç</span>
                        <span class="stat-value">${route.distance}</span>
                        <span class="stat-label">Distance</span>
                    </div>
                    <div class="stat-enhanced">
                        <span class="stat-icon">‚è±Ô∏è</span>
                        <span class="stat-value">${route.time}</span>
                        <span class="stat-label">Duration</span>
                    </div>
                    <div class="stat-enhanced">
                        <span class="stat-icon">üí∞</span>
                        <span class="stat-value">${route.fuel}</span>
                        <span class="stat-label">Cost</span>
                    </div>
                    <div class="stat-enhanced">
                        <span class="stat-icon">üå±</span>
                        <span class="stat-value">${route.co2 || 'N/A'}</span>
                        <span class="stat-label">CO2</span>
                    </div>
                </div>
            </div>
            <div class="route-features">
                ${route.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
            </div>
        `;
        
        routeCard.addEventListener('click', () => selectRoute(route, index));
        routeList.appendChild(routeCard);
    });
    
    routeResults.classList.add('show');
    currentRoutes = routes;
}

// Select Route
function selectRoute(route, index) {
    // Remove previous selection
    document.querySelectorAll('.route-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Select current route
    document.querySelector(`[data-route-index="${index}"]`).classList.add('selected');
    
    // Clear previous routing control
    if (routingControl) {
        map.removeControl(routingControl);
    }
    
    // Add new route to map
    if (route.coordinates) {
        routingControl = L.Routing.control({
            waypoints: route.coordinates.map(coord => L.latLng(coord[0], coord[1])),
            routeWhileDragging: false,
            addWaypoints: false,
            createMarker: function(i, waypoint, n) {
                const isStart = i === 0;
                const isEnd = i === n - 1;
                
                return L.marker(waypoint.latLng, {
                    icon: L.divIcon({
                        html: isStart ? '<i class="fas fa-circle" style="color: #22c55e;"></i>' : 
                                isEnd ? '<i class="fas fa-map-marker-alt" style="color: #ef4444;"></i>' : 
                                '<i class="fas fa-circle" style="color: #3b82f6;"></i>',
                        className: 'custom-div-icon',
                        iconSize: [20, 20],
                        iconAnchor: [10, 20]
                    })
                });
            },
            lineOptions: {
                styles: [{color: '#2563eb', weight: 5, opacity: 0.8}]
            }
        }).addTo(map);
        
        // Fit map to route bounds
        setTimeout(() => {
            if (routingControl.getWaypoints().length > 0) {
                const group = new L.featureGroup(routingControl.getWaypoints().map(wp => L.marker(wp.latLng)));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }, 1000);
    }
    
    selectedRoute = route;
}

// Highlight Recommended Route
function highlightRecommendedRoute(route) {
    setTimeout(() => {
        const firstRoute = document.querySelector('[data-route-index="0"]');
        if (firstRoute) {
            firstRoute.click();
        }
    }, 500);
}

// Load Nearby Incidents into the sidebar
function loadNearbyIncidents() {
    const incidentsList = document.getElementById('incidentsList');
    incidentsList.innerHTML = ''; // Clear existing incidents
    
    routeIncidents.forEach(incident => {
        const incidentItem = document.createElement('div');
        incidentItem.className = `incident-item incident-${incident.severity}`;
        
        incidentItem.innerHTML = `
            <i class="${incident.icon} incident-icon"></i>
            <div class="incident-info">
                <div class="incident-type">${incident.type.replace('_', ' ').toUpperCase()}</div>
                <div class="incident-location">${incident.location}</div>
            </div>
        `;
        
        incidentItem.addEventListener('click', () => {
            if (map) { // Ensure map exists before using it
                map.setView([incident.lat, incident.lng], 15);
            }
        });
        
        incidentsList.appendChild(incidentItem);
    });
}

// Initialize Map Controls
function initializeMapControls() {
    const toggleTraffic = document.getElementById('toggleTraffic');
    const toggleIncidents = document.getElementById('toggleIncidents');
    const centerMap = document.getElementById('centerMap');

    toggleTraffic.addEventListener('click', () => {
        toggleTraffic.classList.toggle('active');
        if (toggleTraffic.classList.contains('active')) {
            // In a real app, this would show actual traffic layer
            showNotification('Traffic Layer Enabled', 'Now showing real-time traffic conditions');
        } else {
            showNotification('Traffic Layer Disabled', 'Traffic layer hidden');
        }
    });

    toggleIncidents.addEventListener('click', () => {
        toggleIncidents.classList.toggle('active');
        if (toggleIncidents.classList.contains('active')) {
            map.addLayer(incidentsLayer);
            showNotification('Incidents Shown', 'Traffic incidents are now visible on map');
        } else {
            map.removeLayer(incidentsLayer);
            showNotification('Incidents Hidden', 'Traffic incidents hidden from map');
        }
    });

    centerMap.addEventListener('click', () => {
        map.setView([28.6139, 77.2090], 11);
    });
}

// Utility Functions
function getSeverityColor(severity) {
    const colors = {
        'critical': '#ef4444',
        'high': '#f59e0b',
        'medium': '#3b82f6',
        'low': '#22c55e'
    };
    return colors[severity] || '#6b7280';
}

function getSeverityRadius(severity) {
    const radii = {
        'critical': 12,
        'high': 10,
        'medium': 8,
        'low': 6
    };
    return radii[severity] || 8;
}

function showNotification(title, message) {
    // Simple notification - in a real app, you'd use a proper notification library
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 90px;
        right: 20px;
        background: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        max-width: 300px;
        border-left: 4px solid var(--primary);
    `;
    
    notification.innerHTML = `
        <h4 style="margin: 0 0 5px 0; color: var(--primary);">${title}</h4>
        <p style="margin: 0; font-size: 0.9rem; color: var(--text-gray);">${message}</p>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
    </script>
</body>
</html>
